name: Deploy Code via CLI

on:
  workflow_dispatch:
  push:
    paths:
      - 'code/**' # Only triggers when code changes

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_ROLE_DEV }}
          aws-region: us-east-1
      - name: Set Commit SHA
        run: echo "SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_ENV

      - name: Create New Launch Template Version
        id: lt_update
        run: |
          FULL_USER_DATA=$(cat <<EOF
          #!/bin/bash
          # Update and Install Nginx
          apt-get update -y
          apt-get install -y nginx

          # Create custom Nginx config for health checks (Matches your ALB TG)
          cat <<EON > /etc/nginx/sites-available/default
          server {
              listen 80 default_server;
              root /var/www/html;
              index index.html;

              location /health {
                  access_log off;
                  return 200 'OK';
              }

              location / {
                  try_files \$uri \$uri/ =404;
              }
          }
          EON

          # Inject the code from your repository
          cat <<EOC > /var/www/html/index.html
          $(cat code/index.html)
          EOC

          # Restart Nginx
          systemctl restart nginx
          systemctl enable nginx
          EOF
          )
          # We update the template with a new User Data script
          # Note: We use a heredoc to build the full bash script for the LT
          NEW_VERSION=$(aws ec2 create-launch-template-version \
            --launch-template-name "${{ secrets.LT_NAME_DEV }}" \
            --version-description "Deployed from GitHub SHA: ${{ env.SHORT_SHA }}" \
            --source-version '$Latest' \
            --launch-template-data "{\"UserData\":\"$(echo "#!/bin/bash
            echo '$USER_DATA_CONTENT' > /var/www/html/index.html
            systemctl restart nginx" | base64 -w 0)\"}" \
            --query 'LaunchTemplateVersion.VersionNumber' \
            --output text)
          
          echo "NEW_LT_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Update ASG and Trigger Refresh
        run: |
          # Point the ASG to the version we just created
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name "${{ secrets.ASG_NAME_DEV }}" \
            --launch-template "LaunchTemplateName=${{ secrets.LT_NAME_DEV }},Version=$NEW_LT_VERSION"

          # Start the rolling update
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "${{ secrets.ASG_NAME_DEV }}"
