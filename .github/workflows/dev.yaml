name: Deploy Code via CLI

on:
  workflow_dispatch:
  push:
    paths:
      - 'code/**' # Only triggers when code changes

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_ROLE_DEV }}
          aws-region: us-east-1
      - name: Set Commit SHA
        run: echo "SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_ENV

      - name: Create New Launch Template Version
        id: lt_update
        run: |
          sed -e '/{{CONTENT}}/{r code/index.html' -e 'd}' code/scripts/user_data.sh > final_script.sh
          echo "ENCODED_USERDATA=$(base64 -w 0 < final_script.sh)" >> $GITHUB_ENV
          NEW_VERSION=$(aws ec2 create-launch-template-version \
            --launch-template-id "${{ secrets.LT_ID }}" \
            --version-description "Deployed from SHA: ${{ env.SHORT_SHA }}" \
            --source-version '$Latest' \
            --launch-template-data "{\"UserData\":\"${{ env.ENCODED_USERDATA }}\"}" \
            --query 'LaunchTemplateVersion.VersionNumber' --output text)
          echo "NEW_LT_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Update ASG and Trigger Refresh
        run: |
          # Point the ASG to the version we just created
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name "${{ secrets.ASG_NAME_DEV }}" \
            --launch-template "LaunchTemplateName=${{ secrets.LT_NAME_DEV }},Version=$NEW_LT_VERSION"

          # Start the rolling update
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "${{ secrets.ASG_NAME_DEV }}"
